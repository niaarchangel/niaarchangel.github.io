<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>HTML Boilerplate</title>
    </head>
    <body>
        <p>Added cors fix</p>
        <script>
            const CLIENT_ID = "c0d475c5-e16e-47e0-aa04-4af577c2b256";
            const CLIENT_SECRET = "c320a9a0-1a52-4d03-88cb-a777bdf3a0f9";
            let url = window.location;

            let access_token = null;
            let refresh_token = null;
            let access_refresh = null;

            let code = new URLSearchParams(url.search).get('code');
            let scope = new URLSearchParams(url.search).get('scope');
            let state = new URLSearchParams(url.search).get('state');

            let beginLogin = async () => {
                try {
                    let newState = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
                    sessionStorage.setItem("state", newState);
                    window.location.replace(`https://api.restream.io/login?response_type=code&client_id=${CLIENT_ID}&redirect_uri=https://niaarchangel.github.io/&state=${newState}`);
                }
                catch (err) {
                    console.log(err);
                }
            }
            
            let refreshCode = async () => {
                console.log("We shouldn't be refreshing yet");
                let response = await fetch('https://api.restream.io/oauth/token', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Access-Control-Allow-Origin': "https://api.restream.io",
                        'Content-Type': 'application/x-www-form-urlencoded',
                        Authorization: `Basic ${btoa(CLIENT_ID + ":" + CLIENT_SECRET)}`
                    },
                    body: `grant_type=refresh_token&refresh_token=${refresh_token}`
                })

                if ("error" in response.body) {
                    beginLogin()
                } else {
                    access_token = response.body.access_token;
                    refresh_token = response.body.refresh_token;
                    access_refresh = setTimeout(refreshCode, ((response.body.accessTokenExpiresIn/60)-5)*60000);
                }
            }

            let exchangeCode = async () => {
                console.log("Exchanging Codes now");
                let response = await fetch('https://api.restream.io/oauth/token', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Access-Control-Allow-Origin': "https://api.restream.io",
                        'Content-Type': 'application/x-www-form-urlencoded',
                        Authorization: `Basic ${btoa(CLIENT_ID + ":" + CLIENT_SECRET)}`
                    },
                    body: `grant_type=authorization_code&redirect_uri=https://niaarchangel.github.io/&code=${code}`
                })

                if ("error" in response.body) {
                    beginLogin()
                } else {
                    access_token = response.body.access_token;
                    refresh_token = response.body.refresh_token;
                    access_refresh = setTimeout(refreshCode, ((response.body.accessTokenExpiresIn/60)-5)*60000);
                    console.log(access_token)
                }
            }

            if (code === null || state !== sessionStorage.getItem("state"))
                beginLogin();
            else if (access_token === null)
                exchangeCode();
		</script>
    </body>
</html>